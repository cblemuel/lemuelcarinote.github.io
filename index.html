<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>CSR Voice CSAT Survey</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
<link rel="icon" href="https://cld.partsimg.com/image/upload/h_200,w_200,f_auto,q_auto/carparts/logos/badge/blue/CP_BADGE_RGB_BLUE_HR.png">
<style>
    body {
        margin: 15px;
    }

    
    * {
        font-family: 'Roboto', Arial, sans-serif !important;
    }

    .wrapper {
        display: block;
        margin: 0 auto;
        max-width: 420px;
    }

    .row {
        padding: 15px 0
    }

    .logo_section {
        display: block;
        margin: 0 auto;
        padding-bottom: 25px;
    }

    .logo_section .logo {
        display: block;
        margin: 0 auto;
    }

    #error {
        line-height: 160%;
        font-weight: normal;
        font-size: 16px;
    }

    #expired_widget {
        display: none;
    }

    #expired_widget p, h3 {
        line-height: 160%;
        font-weight: normal;
        font-size: 16px;
    }

    .satisfaction {
        display: block;
        margin: 0 auto;;
        text-align: center;
        max-width: 350px;
    }

    ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    li {
        padding: 4px;
        display: inline-block
    }

    label {
        display: inline-block;
        margin-bottom: 5px;
        font-weight: bold;
        line-height: 140%;
    }

    #followup {
        font-weight: normal;
    }

    .satisfaction {
        font-size: 22px;
        font-weight: bold;
        color: #333;
        background-color: #ffcd05;
        display: inline-block;
        padding: 12px 20px;
        border: 1px solid #282832;
        border-radius: 4px;
    }

    textarea {
        margin-top: 5px;
        padding: 10px;
        width: 95%;
        border: 1px solid #282832;
        border-radius: 4px;
    }

    input[type="submit"] {
        background-color: #ffcd05;
        border: none;
        color: #282832;
        padding: 12px 30px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 18px;
        cursor: pointer;
        border-radius: 4px;
        font-weight: bold;
        border: 1px solid #282832;
    }

    /* Add a hover effect */
    input[type="submit"]:hover {
        transition: background-color 0.9s;
    }

        
    #response {
        font-size: 14px;
        font-weight: bold;
    }

    @media only screen and (max-width: 460px) {
        .mob-no {
            display: none !important;
            overflow: hidden !important;
            width: 0 !important;
            height: 0 !important;
        }
    }
</style>
<meta name="robots" content="noindex, nofollow">
</head>
<body>

<div class="wrapper">
    <div class="logo_section" id="logo_section"></div>

    <div id="error">
    </div>
    
    <div id="expired_widget">
        <p align="center">
            Thank you for your interest, but the survey is now closed. 
            <br class="mob-no">We hope to hear from you in the future!
        </p>
    </div>

    <div id="form_widget">
        <h3>Thanks for taking the time to share your rating!</h3>
        
        <form name="csat">
            <div class="row_satisfaction">
                <div class="satisfaction" id="csat_rating"></div>
            </div>

            <div class="row">
                <label id="followup" for="comments"></label>
                <textarea id="comments" name="comments" rows="6" cols="50" value=""></textarea>
            </div>

            <div class="row" align="center">
                <input id="btnSubmit" type="submit" value="Submit">
                <div id="response"></div>
            </div>
        </form>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
    var form = document.forms['csat'];
    var btnSubmit = document.getElementById("btnSubmit");

    var csid = JSON.parse(atob(new URLSearchParams(window.location.search).get('csid')));
    var csrating = atob(new URLSearchParams(window.location.search).get('csrating'));
    var csr_voice_csat_link_expiry = csid.csr_voice_csat_link_expiry || null;
    var csr_voice_csat_invite_at = csid.csr_voice_csat_invite_at || null;
    var email = csid.email;
    var name = csid.firstname + " " + csid.lastname;
    var agent_username = csid.agent_user_name;
    var order_id = csid.merchant_order_id;
    var domain_name = csid.domain_name + " / " + csid.server_name;
    var domain = csid.domain_name ? csid.domain_name.toLowerCase() : null;
    var sitecode = csid.sitecode ? csid.sitecode.toLowerCase() : null;
    var disposition = csid.disposition_text;

    // Function to add days to a date
    function addDays(date, days) {
        let result = new Date(date);
        result.setDate(result.getDate() + days);
        
        // Adjust the result date to the Pacific Time zone (US & Canada)
        const options = {
            timeZone: 'America/Los_Angeles',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };

        // Format and parse to get the correct date in the specified timezone
        let adjustedDate = new Date(
            new Intl.DateTimeFormat('en-US', options).format(result)
        );

        return adjustedDate;
    }

    // Function to get the current date in Pacific Time
    function getCurrentDatePacificTime() {
        return new Date(
            new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/Los_Angeles',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }).format(new Date())
        );
    }

    // Function to display the appropriate logo based on the site code or domain
    function displayLogo(domain, sitecode) {
        let logoSection = document.getElementById("logo_section");
        
        if (domain === 'carparts.com') {
            logoSection.innerHTML = "<img class='logo' style='width:200px; height: auto' src='https://cdn.getblueshift.com/pictures/227464/content/carpartscom.png' alt='CarParts.com'>";
        } else if (sitecode === 'carpartswholesale' || sitecode === 'carpartswholesale-whi') {
            logoSection.innerHTML = "<img class='logo' style='width:180px; height: auto' src='https://cdn.getblueshift.com/pictures/194663/content/carpartswholesale.png' alt='CarParts.com'>";
        } else if (sitecode === 'carpartswholesale.ebay-ams.com') {
            logoSection.innerHTML = "<img class='logo' style='width:200px; height: auto' src='https://cdn.getblueshift.com/pictures/162960/content/ebay-cpw.png' alt='CarPars Wholesale on eBay'>";
        } else if (sitecode === 'carparts.ebay-ams.com') {
            logoSection.innerHTML = "<img class='logo' style='width:200px; height: auto' src='https://cdn.getblueshift.com/pictures/162481/content/ebay-carparts.png' alt='CarParts on eBay'>";
        } else if (sitecode === 'jcwhitney.ebay-ams.com') {
            logoSection.innerHTML = "<img class='logo' style='width:200px; height: auto' src='https://cdn.getblueshift.com/pictures/162479/content/ebay-jcwhitney.png' alt='JC Whitney on eBay'>";
        } else if (sitecode === 'returnedcarparts.ebay-ams.com') {
            logoSection.innerHTML = "<img class='logo' style='width:200px; height: auto' src='https://cdn.getblueshift.com/pictures/163612/content/ebay-rcp.png' alt='Returned Car Parts'>";
        }
    }

    // Follow-up question
    function csatFollowupQ(csrating) {
        document.getElementById("csat_rating").textContent = csrating;
        // Define the HTML code for each radio button value
        let msg;
        switch (csrating) {
        case '1':
            msg = "<strong>We’re sorry to hear that your expectations weren’t met. We’d&nbsp;love&nbsp;to make things right!</strong> <br><br>Please feel free to share any additional comments or suggestions so we can fine-tune our service.";
            break;
        case '2':
            msg = "<strong>We understand that your experience could have been better, and we’re committed to improving.</strong> <br><br>Please feel free to share any additional comments or suggestions so we can fine-tune our service.";
            break;
        case '3':
            msg = "<strong>It seems there’s room for improvement, and we’d like to know how we can make your future experience better!</strong> <br><br>Please feel free to share any additional comments or suggestions so we can fine-tune our service.";
            break;
        case '4':
            msg = "<strong>We’re glad you had a good experience, but we’re always striving for excellence.</strong> <br><br>Please feel free share additional comments or suggestions so we fine-tune our service:";
            break;
        case '5':
            msg = "<strong>We’re thrilled that you had a great experience! Your&nbsp;feedback&nbsp;motivates us to keep delivering top-notch service.</strong> <br><br>Please feel free to share any additional comments or suggestions if there’s anything else we can do for you:";
            break;
        // Add more cases for each radio button value
        default:
            htmlCode = "<strong>Please share additional comments or suggestions to help us improve our service:<strong>";
        }

        // Insert the HTML code into the div element
        document.getElementById('followup').innerHTML = msg;
    }

    // Function to handle the CSAT form submission - Legacy
    function handleCSATLegacy(csr_voice_csat_invite_at) {
        let currentdate = getCurrentDatePacificTime();

        if (csr_voice_csat_invite_at === null) {
            document.getElementById('expired_widget').style.display = 'block';
            document.getElementById('form_widget').style.display = 'none';
        } else {
            let linkexpirydate = addDays(new Date(csr_voice_csat_invite_at), 8);

            if (linkexpirydate > currentdate) {
                document.forms['csat'].addEventListener('submit', function (e) {
                    e.preventDefault();
                    submitCSATForm();
                });
            } else {
                document.getElementById('expired_widget').style.display = 'block';
                document.getElementById('form_widget').style.display = 'none';
            }
        }
    }

    // Function to handle the CSAT form submission - Dynamic
    function csatExpiryEval(csr_voice_csat_link_expiry) {
        let currentdatetime = getCurrentDatePacificTime();
        let linkexpiry = csr_voice_csat_link_expiry;
        linkexpiry_datetime = new Date(
            linkexpiry.split("T")[0].split("-")[0], // year
            linkexpiry.split("T")[0].split("-")[1] - 1, // month ( subtract 1 because months are 0-based)
            linkexpiry.split("T")[0].split("-")[2], // day
            linkexpiry.split("T")[1].split(":")[0], // hour
            linkexpiry.split("T")[1].split(":")[1], // minutes
            linkexpiry.split("T")[1].split(":")[2].replace(/\-.*/, '') // seconds (remove timezone offset)
        );
        if (linkexpiry_datetime > currentdatetime) {
            document.forms['csat'].addEventListener('submit', function (e) {
                e.preventDefault();
                submitCSATForm();
            });
        } else {
            document.getElementById('expired_widget').style.display = 'block';
            document.getElementById('form_widget').style.display = 'none';
        }
    }

    // Function to submit the CSAT form
    function submitCSATForm() {
        let xhr = new XMLHttpRequest();
        let radioselectedValues = {
            satisfaction: $("input[name='satisfaction']:checked").val()
        };
        let comments = document.getElementById("comments").value;
        let message = `Order Id: ${order_id}\nDomain/Server: ${domain_name}\n\nDisposition: ${disposition}\nCSR: ${agent_username}\n\nOn a scale of 1 to 5, how satisfied were you with the assistance provided by our Customer Service agent? \n${radioselectedValues.satisfaction}\n\nPlease share additional comments or suggestions to help us improve our service: \n${comments}`;
        let data = {
            title: "CSR Voice CSAT Survey",
            email: email,
            message: message,
            agent_username: agent_username,
            order_id: order_id,
            domain_name: domain_name,
            disposition: disposition,
            satisfaction: radioselectedValues.satisfaction,
            comments: comments
        };

        if (radioselectedValues.satisfaction === "" || radioselectedValues.satisfaction === undefined) {
            document.getElementById("response").innerHTML = "<p style='color: #cc0202'>Please provide answers.</p>";
        } else {
            document.getElementById("response").innerHTML = "<p>Please wait...</p>";
            xhr.open('POST', 'https://api.kustomerapp.com/v1/hooks/form/62ab35f54d6d983dd120afb0/6ff02ab5fceb6215898281533c8138872ad096d908bd5174545726d9f836a5b0');
            xhr.setRequestHeader("Accept", "application/json;charset=UTF-8");
            xhr.setRequestHeader("Authorization", "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY1NzlkNDhmNTU4YzIxYzYyZGY1MTk0ZiIsInVzZXIiOiI2NTc5ZDQ4ZDAwMzE4MzVmNDhhYTAyMjgiLCJvcmciOiI2MmFiMzVmNTRkNmQ5ODNkZDEyMGFmYjAiLCJvcmdOYW1lIjoiY2FycGFydHMiLCJ1c2VyVHlwZSI6Im1hY2hpbmUiLCJwb2QiOiJwcm9kMSIsInJvbGVzIjpbIm9yZy5hZG1pbiJdLCJhdWQiOiJ1cm46Y29uc3VtZXIiLCJpc3MiOiJ1cm46YXBpIiwic3ViIjoiNjU3OWQ0OGQwMDMxODM1ZjQ4YWEwMjI4In0.hHPqxf04wPqBGyiMjllKqOswPhPMnFoLdaSReRrK5ME");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    let form = document.forms['csat'];
                    form.btnSubmit.style.cursor = "default";
                    form.btnSubmit.value = "Submitted";
                    form.btnSubmit.disabled = true;
                    form.btnSubmit.style.backgroundColor = "#f7f7f7";
                    document.getElementById("response").innerHTML = "<p>Thank you for your feedback!</p>";
                }
            };
            xhr.send(JSON.stringify(data));
        }
    }

    // Main execution starts here
    $(document).ready(function () {
        if (!csid || !csrating) {
            document.getElementById("error").innerHTML = "<p>Broken link! <br>Please reply to the email, and our customer service team will be happy to assist you further.</p>";
            document.getElementById('expired_widget').style.display = 'none';
            document.getElementById('form_widget').style.display = 'none';
        } else {
            
            // Display the appropriate logo
            displayLogo(domain, sitecode);
            
            // Follow-up question
            csatFollowupQ(csrating);

            // Handle the CSAT form submission logic
            if (csr_voice_csat_link_expiry != null) {
                csatExpiryEval(csr_voice_csat_link_expiry);
            } else if (csr_voice_csat_invite_at != null) {
                handleCSATLegacy(csr_voice_csat_invite_at); 
            } else {
                document.getElementById('expired_widget').style.display = 'block';
                document.getElementById('form_widget').style.display = 'none';
            }
        }
    });
</script>

</body>
</html>
